permissions:
  contents: write

name: Ingest Blog Post

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Source article URL'
        required: true

jobs:
  ingest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # so we can push back cleanly

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install deps
        run: npm i jsdom @mozilla/readability node-fetch openai cloudinary sharp

      - name: Ingest URL â†’ JSON post + image
        id: ingest
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          CLOUDINARY_URL: ${{ secrets.CLOUDINARY_URL }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          SITE_BASE_URL: ${{ secrets.SITE_BASE_URL }} # e.g. https://flipwiseconsulting.org/#/blog
        run: node scripts/ingest-url.mjs '${{ github.event.inputs.url }}'

      - name: Commit new content
        env:
          BRANCH: ${{ github.ref_name }}   # usually 'main' for workflow_dispatch
        run: |
          git config user.name "flipwise-bot"
          git config user.email "bot@users.noreply.github.com"
          git add public/content
          git commit -m "chore(blog): ingest ${{ github.event.inputs.url }}" || echo "No changes"
          git pull --rebase origin "$BRANCH" || true
          git push origin HEAD:"$BRANCH"

      - name: Trigger Netlify build
        run: curl -X POST '${{ secrets.NETLIFY_BUILD_HOOK }}'

      - name: Wait a few seconds
        run: sleep 5

      - name: ðŸ“¸ Post new blog to Instagram (via Page token)
        if: ${{ steps.ingest.outputs.cloudinary_url != '' }}
        run: node scripts/igPublish.js
        env:
          FB_LONG_USER_TOKEN: ${{ secrets.FB_LONG_USER_TOKEN }}
          PAGE_ID: ${{ secrets.PAGE_ID }}
          MEDIA_URL: ${{ steps.ingest.outputs.cloudinary_url }}
          POST_TITLE: ${{ steps.ingest.outputs.title }}
          POST_EXCERPT: ${{ steps.ingest.outputs.excerpt }}
          POST_URL: ${{ steps.ingest.outputs.url }}
          POST_TAGS: "realestate,flipwise,renovation,investing"
          IS_VIDEO: "false"
          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}

      - name: ðŸ“˜ Post new blog to Facebook Page
        if: ${{ steps.ingest.outputs.cloudinary_url != '' }}
        run: node scripts/fbPublish.js
        env:
          FB_LONG_USER_TOKEN: ${{ secrets.FB_LONG_USER_TOKEN }}
          PAGE_ID: ${{ secrets.PAGE_ID }}
          FB_IMAGE_URL: ${{ steps.ingest.outputs.cloudinary_url }}
          FB_MESSAGE: "${{ steps.ingest.outputs.title }}\n\n${{ steps.ingest.outputs.excerpt }}\n\n${{ steps.ingest.outputs.url }}"
          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}

      - name: ðŸ’¼ Post new blog to LinkedIn (Page or Person)
        if: ${{ steps.ingest.outputs.cloudinary_url != '' }}
        run: node scripts/liPublish.js
        env:
          LINKEDIN_TOKEN: ${{ secrets.LINKEDIN_TOKEN }}
          LINKEDIN_ACTOR_URN: ${{ secrets.LINKEDIN_ACTOR_URN }}   # urn:li:organization:XXXX or urn:li:person:YYYY
          LI_IMAGE_URL: ${{ steps.ingest.outputs.cloudinary_url }}
          LI_TITLE: ${{ steps.ingest.outputs.title }}
          LI_DESCRIPTION: ${{ steps.ingest.outputs.excerpt }}
          LI_URL: ${{ steps.ingest.outputs.url }}
          # Optional custom text (falls back to title + excerpt)
          LI_COMMENTARY: ${{ steps.ingest.outputs.social_text }}


